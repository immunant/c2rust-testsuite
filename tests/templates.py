import os
import stat

from tests.util import *
from jinja2 import Template

TRANSPILE_SH: str = r"""#!/usr/bin/env bash
# this file was autogenerated by templates.py
set -e; set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "$0" )" && pwd)"

RUST_BACKTRACE=1 c2rust transpile \
    --output-dir "$SCRIPT_DIR/repo" {{main}} \
    ${EXTRA_TFLAGS:---overwrite-existing} \
    compile_commands.json \
    -- ${EXTRA_CFLAGS:--w} \
     2>&1 | tee `basename "$0"`.log

if [[ -f "$SCRIPT_DIR/build.rs" ]]; then
    cp "$SCRIPT_DIR/build.rs" "$SCRIPT_DIR/repo"
fi
"""


def autogen(conf: Config):
    for (cf, yaml) in conf.project_conf.items():
        transpile = yaml.get("transpile")
        if transpile:
            main = transpile.get("main")
            if main:
                m = f"--main {main}"
            else:
                m = "--emit-build-files"
            out = Template(TRANSPILE_SH).render(main=m)
            out_path = os.path.join(
                os.path.dirname(cf),
                "transpile.gen.sh"
            )
            with open(out_path, 'w') as fh:
                fh.writelines(out)
            os.chmod(out_path, stat.S_IREAD | stat.S_IWRITE | stat.S_IEXEC)
